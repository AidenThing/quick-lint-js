<!---{
"title": "quick-lint-js blog"
}--->

<!DOCTYPE html>
<!-- Copyright (C) 2020  Matthew "strager" Glazar -->
<!-- See end of file for extended copyright information. -->
<html>
  <head>
    <%- await include("../common-head.ejs.html") %> <%- await
    include("./blog-head.ejs.html") %>
    <script>
      //<%
      let ejs = await import("ejs");
      let fs = await import("node:fs");
      let path = await import("node:path");
      let { readFrontMatterFromFileAsync } = await importFileAsync("../../src/front-matter.mjs");

      async function loadBlogPostsAsync() {
        let directories = await fs.promises.readdir(absoluteFilePath('.'), {withFileTypes: true});
        directories = directories.filter(dir => dir.isDirectory());
        let posts = await Promise.all(directories.map(async dir => {
          let indexPath = absoluteFilePath(path.join(dir.name, "index.ejs.html"));
          let meta = await readFrontMatterFromFileAsync(indexPath);
          if (typeof meta.blogDate === 'undefined') {
            throw new Error(`Missing blogDate in front matter of ${indexPath}`);
          }
          return {
            dir: dir.name,
            meta: meta,
          };
        }));
        sortPostsReverseChronologically(posts);
        return posts;
      }

      function sortPostsReverseChronologically(posts) {
        posts.sort((a, b) => {
          if (a.meta.blogDate < b.meta.blogDate) return +1;
          if (a.meta.blogDate > b.meta.blogDate) return -1;
          return 0;
        });
      }
      //%>
    </script>
    <link href="../main.css" rel="stylesheet" />
  </head>
  <body class="side-bar-nav">
    <header><%- await include("../common-nav.ejs.html") %></header>

    <main>
      <h2>quick-lint-js blog</h2>

      <ul>
        <% for (let post of await loadBlogPostsAsync()) { %>
        <li>
          <a href="<%= post.dir %>/"
            ><%- post.meta.linkLabelHTML ?? ejs.escapeXML(post.meta.title) %></a
          >
        </li>
        <% } %>
      </ul>
    </main>

    <footer><%- await include("../common-footer-nav.ejs.html") %></footer>
  </body>
</html>

<!--
quick-lint-js finds bugs in JavaScript programs.
Copyright (C) 2020  Matthew "strager" Glazar

This file is part of quick-lint-js.

quick-lint-js is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

quick-lint-js is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with quick-lint-js.  If not, see <https://www.gnu.org/licenses/>.
-->
